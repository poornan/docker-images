# escape=`
#Copyright (c) 2014, 2020, Oracle and/or its affiliates.
#
#Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.
#
# ORACLE DOCKERFILES PROJECT
# --------------------------
# This is the Dockerfile for WebLogic 12.2.1.3 Quick Install Distro
#
# REQUIRED FILES TO BUILD THIS IMAGE
# ----------------------------------
# (1) fmw_12.2.1.3.0_wls_quick_Disk1_1of1.zip
#     Download the Developer Quick installer from http://www.oracle.com/technetwork/middleware/weblogic/downloads/wls-for-dev-1703574.html
#
# (2) server-jre-8uXX-linux-x64.tar.gz
#     Download from http://www.oracle.com/technetwork/java/javase/downloads/server-jre8-downloads-2133154.html
#
# HOW TO BUILD THIS IMAGE
# -----------------------
# Put all downloaded files in the same directory as this Dockerfile
# Run:
#      $ docker image build --file Dockerfile0.developer -t oracle/weblogic:12.2.1.3-developer .
#
# IMPORTANT
# ---------
# The resulting image of this Dockerfile contains a WLS Empty Domain.
#
# Extend base JRE image
# You must build the image by using the Dockerfile in GitHub project `../../../OracleJava/java8`
# ----------------------------------------------------------------------------------------------
FROM dockeronwindows/ser-java0:ananth as builder
USER ContainerAdministrator
# Labels
# ------
LABEL "provider"="Oracle"                                               `
      "maintainer"="Monica Riccelli <monica.riccelli@oracle.com>"       `
      "issues"="https://github.com/oracle/docker-images/issues"         `
      "port.admin.listen"="7001"                                        `
      "port.administration"="9002"


# Common environment variables required for this build (do NOT change)
# --------------------------------------------------------------------
ENV ORACLE_HOME=C:\u01\oracle `
    # USER_MEM_ARGS="-Djava.security.egd=file:\dev\.\urandom" `
    PATH=%PATH%;%JAVA_HOME%\bin;C:\u01\oracle\oracle_common\common\bin;C:\u01\oracle\wlserver\common\bin

# Setup filesystem and oracle user
# Adjust file permissions, go to \u01 as user 'oracle' to proceed with WLS installation
# ------------------------------------------------------------
RUN mkdir C:\u01\oracle
#&&
    # useradd -b \u01 -d \u01\oracle -m -s \bin\bash oracle && `
    # chown oracle:root -R /u01 && `
    # chmod -R 775 /u01

# Environment variables required for this build (do NOT change)
# -------------------------------------------------------------
ENV FMW_PKG=fmw_12.2.1.3.0_wls_quick_Disk1_1of1.zip `
    FMW_JAR=fmw_12.2.1.3.0_wls_quick.jar

# Copy packages
# -------------
COPY $FMW_PKG install.file oraInst.loc C:\u01\

# Install
# ------------------------------------------------------------
# USER ContainerUser
RUN cd C:\u01 && %JAVA_HOME%\bin\jar xf C:\u01\%FMW_PKG% && cd \ && `
    %JAVA_HOME%\bin\java -jar C:\u01\%FMW_JAR% -silent -responseFile C:\u01\install.file -invPtrLoc C:\u01\oraInst.loc -jreLoc %JAVA_HOME% -ignoreSysPrereqs -force -novalidation ORACLE_HOME=%ORACLE_HOME% && `
    DEL /Q C:\u01\%FMW_JAR% C:\u01\%FMW_PKG% C:\u01\install.file && `
    RD /S /Q C:\u01\oracle\cfgtoollogs

# Final image stage
FROM dockeronwindows/ser-java0:ananth
USER ContainerUser

ENV ORACLE_HOME=C:\u01\oracle `
    # USER_MEM_ARGS="-Djava.security.egd=file:\dev\.\urandom" `
    SCRIPT_FILE=C:\u01\oracle\createAndStartEmptyDomain.bat `
    HEALTH_SCRIPT_FILE=C:\u01\oracle\get_healthcheck_url.bat


# Domain and Server environment variables
# ------------------------------------------------------------
ENV DOMAIN_NAME="${DOMAIN_NAME:-base_domain}" `
    ADMIN_LISTEN_PORT="${ADMIN_LISTEN_PORT:-7001}"  `
    ADMIN_NAME="${ADMIN_NAME:-AdminServer}" `
    DEBUG_FLAG=true `
    PRODUCTION_MODE=dev `
    ADMINISTRATION_PORT_ENABLED="${ADMINISTRATION_PORT_ENABLED:-true}" `
    ADMINISTRATION_PORT="${ADMINISTRATION_PORT:-9002}"

# Setup filesystem and oracle user
# Adjust file permissions, go to \u01 as user 'oracle' to proceed with WLS installation
# ------------------------------------------------------------
RUN mkdir  C:\u01\oracle
# RUN icacls "C:\u01\oracle" /grant:r ContainerUser:(OI)(CI)F /T
# ENV PATH=%PATH%;%JAVA_HOME%\bin;C:\u01\oracle\oracle_common\common\bin;C:\u01\oracle\wlserver\common\bin
USER ContainerAdministrator
RUN setx /M PATH %JAVA_HOME%\bin;C:\u01\oracle\oracle_common\common\bin;C:\u01\oracle\wlserver\common\bin;%PATH%
# USER ContainerUser
# && `
#    chmod 775 \u01 && `
#    useradd -b \u01 -d \u01\oracle -m -s \bin\bash oracle && `
#    chown oracle:root \u01

COPY --from=builder C:\u01 C:\u01

# Copy scripts
#-------------
COPY container-scripts\createAndStartEmptyDomain.bat container-scripts\create-wls-domain.py container-scripts\get_healthcheck_url.bat \u01\oracle\

# RUN chmod +xr $SCRIPT_FILE $HEALTH_SCRIPT_FILE && `
#    chown oracle:root $SCRIPT_FILE \u01\oracle\create-wls-domain.py $HEALTH_SCRIPT_FILE
# RUN icacls "C:\u01\oracle" /grant:r ContainerUser:(OI)(CI)F /T
#USER ContainerUser

HEALTHCHECK --start-period=10s --timeout=30s --retries=3  CMD curl -k -s --fail `$HEALTH_SCRIPT_FILE` || exit 1
WORKDIR ${ORACLE_HOME}

# Define default command to start script.
CMD ["C:\u01\oracle\createAndStartEmptyDomain.bat"]
